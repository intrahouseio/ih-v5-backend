## Структура и архитектура системы v5

Система состоит из сервисов, объединенных компонентом holder (паттерн Посетитель)

**holder** - это EventEmitter без своего функционала (в отличие от houser v3, v4)

Сервисы используют holder  для: 
 - генерации сообщений другим сервисам (emit)
 - получения сообщений (on)
 - доступа к структурам *Set друг друга (предпочтительно только чтение), которые миксинятся однажды на старте каждого сервиса

Сервисы ничего не знают друг о друге. Для доступа к  данным имеются единые модули доступа.
Такая архитектура позволяет добавлять функционал, просто добавив новый сервис. 

На текущий момент в системе имеются сервисы предметной области (Domain layer):
 - deviceservice
 - pluginservice
 - sceneservice
 - trenservice
 - alertservice

Сервисы, обеспечивающие связь (server):
 - webserver
 - udpserver 

## Модули доступа к данным

 - datamanager - доступ к настройкам проекта и системным  настройкам. 
   EventEmitter, генерирует события inserted, updated, removed для таблиц (подмножества в коллекции)

   Хранилище данных из коробки **nedb**, замена модуля dbstore должна позволить перейти на **mongodb**

 - hdbconnector - доступ к историческим данным
   Заменой коннектора нужно обеспечить подключение разных СУБД 

 - доступ к оперативным данным через holder.

## Сервисы 
 Каждый сервис прикладного уровня состоит из engine и mate.

  - **engine** - формирует множество объектов *Set (devSet, sceneSet, unitSet, ..)
    Каждый объект создается как класс ( Devo, Sceno, Unito, )
    Реализует прикладной функционал

  - **mate** - загружает данные через  datamanager при старте.
    Слушает datamanager и вызывает ф-и engine для изменения объектов при изменении настроек

### deviceservice

  1. Формирует  devSet при старте (свойства устройства, параметры, сохраненные значения)
  2. Слушает событие получения данных от плагинов: **get:devicedata**
     Пишет значения в devSet, генерирует **changed:devicedata**
  3. Слушает событие получения команд для устройств: **get:devicecommand**  
     Проверяет возможность выполнения команды устройством (??), генерирует **send:devicecommand** // для плагина?
  4. Слушает  device agent-a, выполняет логирование уровня устройства?
  5. Сохраняет текущие значения свойств устройства, особенно параметры!! Где и кто?? 
  6. Изменяет элементы  devSet (функции запускает mate) при изменении устройств и типов

#### Элемент devSet - devo
  1. Хранит текущие значения каждого свойства
  2. Выполняет изменение значения (с использованием функций onRead, calculate)
  3. При изменении контролирует, форматирует, логирует, устанавливает ошибку  
  4. Передается в сценарии, где предоставляет доступ к своим свойствами для чтения. Запись и выполнение команд из сценариев??

### pluginservice - запускает и взаимодействует с плагинами

  1. Формирует  unitSet при старте (экземпляры плагина, параметры, каналы!! Их привязка к устройствам??)
  2. Запускает плагины, передает им параметры и каналы
  3. Генерирует **get:devicedata**  при получении данных от плагина
  4. Слушает  **send:devicecommand** и отправляет плагину после переработки механизмом каналов
  5. Слушает  **send:plugincommand** и отправляет плагину 
  6. Изменяет элементы  unitSet (функции запускает mate) При изменении параметров плагина и каналов??
  7. Принимает подписки от плагинов, отдает при изменении таблиц системы или плагина 
  8. Отработка других запросов от плагинов  (API плагина) 
  9. Логирование, устанавливает ошибку плагина
 10. Транзит transferdata: интерфейс <--> сервер  <--> плагин
 11. Сохраняет состав каналов плагина (через mate - dm)   
 12. Сохраняет текущее значение каналов плагина (через mate)   

#### Элемент unitSet - unito
  1. Строит таблицы Канал-свойство устройства для чтения + Устройство(свойство) - Канал при записи (выполнении команды)
  2. Реализует маппинг: Канал - устройство при получении данных с каналов
  3. Реализует маппинг: устройство  - канал при получении команды перед передачей на плагин
  4. Хранит текущие значения каналов, полученные от плагина
  

### trendservice - пишет исторические данные устройств в БД для графиков, отчетов и timeline 

  1. Формирует trendSet - данные об алгоритмах сохранения данных. Эти данные в devSet не храню
     ?? Также загружаются данные из СУБД, если для расчета нужны предыдущие данные (timeline^ интерполяция)
  2. Слушает событие изменения данных **changed:device:data** для устройств, сохраняемых по изменению
  3. Слушает событие получения данных **accepted:device:data** для устройств, сохраняемых при получении
  4. Слушает таймеры для устройств, сохраняемых по таймерам
  5. Выполняет обработку данных (min, max, средние, интерполяция??, timeline??!!!)
  6. Пишет данные в СУБД через dbconnector
  7. Изменяет правила сохранения (функции запускает mate) при изменении настроек

#### Элемент trendSet - trendo
  1. Хранит правила сохранения
  2. Хранит промежуточные данные для расчетов
  3. Реализует алгоритмы расчета (delta; min, max,...)
  
  
### sceneservice - выполняет сценарии и действия по расписанию

  1. Формирует  sceneSet при старте (загружает cкрипты, статус сценария, устройства для запуска (мультисценарии))
     Также загружаются данные, хранимые сценарием - постоянные данные сценария?
     Формирует   scheduSet при старте () Или отдельный сервис??
  2. Слушает событие изменения данных **changed:devicedata** для запуска сценариев по триггерам
  3. Слушает таймеры для сценариев, запускаемых периодически, а также внутренние периодические таймеры сценариев 
  4. Слушает таймеры для сценариев (действий, команд), запускаемых в заданный момент времени (по расписанию),
     а также внутренние таймеры сценариев на временную точку
  5. По командам из сценария this. выполняет действия ????
  6. По командам из сценария пишет данные в СУБД через dbconnector
  7. Изменяет элементы   sceneSet (функции запускает mate) при изменении сценариев

#### Элемент sceneSet - sceno
  1. Хранит  скрипт, таймеры, массив слушателей
  2. Реализует алгоритмы расчета
  

### alertservice (отслеживает текущие алерты??? Оперативный журнал - незаконченные события??

  Нужно отдельно, если будут алерты на уровне устройств, помимо сценариев! Если через сценарии - перенести туда??

 