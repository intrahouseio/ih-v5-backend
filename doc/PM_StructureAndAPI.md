# Project Manager. Структуры и API

Интерфейсы PM формируются на основании данных, запрашиваемых с сервера (декларативный подход)

1. **Структуры**, описывающие интерфейсы (метаданные), хранятся в файлах в папке sysbase.

  Эти файлы могут изменяться (в рамках заложенного функционала) без внесения изменений в код сервера.

2. **API** позволяет запрашивать описания интерфейсов и динамические данные GET запросом, а также редактировать динамические данные POST запросом. В любом запросе method является обязательным параметром:
  
  **/api/admin?method=getmeta&.....**  - GET запросы получения метаданных (декларативных описаний)
  **/api/admin?method=get&.....**  - GET запросы получения динамических данных

  **/api/admin** - POST запрос на редактирование данных, тело запроса содержит JSON.
  ```
     { "method":"insert",
       ......
     } 
  ```

 Ответ сервера (статус 200) приходит в формате JSON и обязательно содержит поле **response**. Если в результате есть данные, поле data содержит данные, обычно объект или массив:

```
     { "response":1,
       "data":{.....}
     } 
```

При ошибке также передается статус 200 c response=0:
```
     { "response":0,
       "message":"Текст ошибки",
       "error":"Код ошибки"
     } 
  ```

---
## Метаданные PM, хранение и формат
----
Все метаданные представлены в формате JSON в отдельных файлах *.json.
Стандартно файлы возвращаются как есть, только делается перевод для строк, помеченных $, например "name":"$Text"

Перевод берется из соответствующего файла pmmessages.json

Метаданные описывают интерфейсы PM, которые в общем случае состоят из:

```
________________________________________________________________________
| М|  Д   |     
| Е|  Е   | Компонент, состоящий из одной или нескольких вкладок
| Н|  Р   | 
| Ю|  Е   | На вкладке располагается форма или другой (под)компонент
|  |  В   | (редактор мнемосхем, редактор кода, ....)
|  |  О   | 
________________________________________________________________________
```

Внутри папки sysbase для каждого типа метаданных существуют папки:

  - **menu** - файлы c описанием меню. На текущий момент содержит pmmenu.json
               (возможны усеченные меню в записимости от конфигурации?)
    
    - запрос меню: /api/admin?method=get&type=menu&id=pmmenu
       - type - menu
       - id - идентификатор (имя файла меню)

    - ответ: data - массив. Элемент массива описывает элемент меню:
       - route - имя целевого объекта (обычно ид-р дерева)

    ```
    {"id":"1", route: "dev", title: "Устройства", tooltip: "Устройства", icon: "dev"}
    ```


  - **tree** - файлы с описанием деревьев
    - запрос структуры дерева: /api/admin?method=getmeta&type=tree&id=dev
       - type - tree
       - id - идентификатор дерева (имя route из меню)

    - ответ: data - объект. Всегда имеет раздел "common" (общее описание) и разделы для каждого поддерева в дереве (возможно несколько корневых элементов):

    ```
    {"common":{
      "popup":{....}
     },

     "devices":{
       "parent":{
         "popup":{....}
         "defaultComponent: "devicefolder"
       },
       "child":{
        "popup":{....}
        "defaultComponent: "deviceview"
       }
       
     },
     "types":{
         "parent":{
         "popup":{....}
         "defaultComponent: "typefolder"
       },
       "child":{
        "popup":{....}
        "defaultComponent: "typeview"
       }
     }
    }
    ```
      Для каждого поддерева (в примере devices, types) есть отдельное описание для папок (parent) и листьев (child)

       - popup - описание popup меню
       - defaultComponent - имя целевого объекта (компонента) при выборе узла дерева


  - **component** - файлы с описанием компонентов 
  
  - запрос компонента: /api/admin?method=getmeta&type=component&id=typeview
       - type - component
       - id - идентификатор компонента

    - ответ: data - объект.
         
         - tabs - описывает массив вкладок. Каждая вкладка имеет свойство component - массив, описывающий подкомпоненты этой вкладки (форма, редактор и т д)

        - defaultTab - id вкладки, которая будет открыта при вызове компонента
        Обычно первый элемент массива tabs


    ```
    {
    "tabs": [
      { "id": "tabDeviceFolder",  "title": "Свойства папки", "component": [{ "id": "formDeviceFolder", "type": "form" }]  }
      ],
    "defaultTab": "tabDeviceFolder"
    }
    ```

  - запрос всех компонентов: /api/admin?method=getmeta&type=components
   
    Есть возможность запросить все компоненты одним запросом
      - type - components
      - id - идентификатор компонента НЕ НУЖЕН

    В этом случае объект data собирается из всех файлов папки, имя ключа - имя файла ( id компонента)

    ```
    {
      "typefolder":{
        "tabs": [
          { "id": "tabDeviceFolder",  "title": "Свойства папки", "component": [{ "id": "formDeviceFolder", "type": "form" }]  }
        ],
        "defaultTab": "tabDeviceFolder"
      }, 
      "devicefolder":{...},
      "deviceview":{...}
    }    
    ```

    **!!!** Аналогично можно запросить все деревья или все формы, добавив к типу 's':

    /api/admin?method=getmeta&type=trees
  
    /api/admin?method=getmeta&type=forms

  - **form** - файлы с описанием форм

  Формы состоят из так называемых плашек и описывают размещение плашек и поля данных на каждой плашке. Форма может содержать данные из разных таблиц, но каждая плашка содержит данные из одной таблицы. Таблицы описаны в sysbase/dbs/tables.json



  - запрос формы: /api/admin?method=getmeta&type=form&id=formTypeFolder
       - type - form
       - id - идентификатор формы

  - ответ: data - объект.
         
      - grid - массив плашек формы
      - breadcrumbs - в форму включается навигация (хлебные крошки). Указывается, по какому дереву она строится
      - Объекты, описывающие плашки. Ключ - идентификатор плашки, значение - массив полей.

    ```
    {
      "grid": [
         { "id": "p1", "xs": 12, "class": "main", "table": "typegroup" },
          { "id": "p2", "xs": 12, "class": "main", "table": "typegroup", "height": 250 }
       ],
      "spacing": 10,
      "breadcrumbs": { "tree": "types" },

      "p1": [
         { "prop": "name", "title": "$Name", "type": "input" }
        ],
     "p2": [{ "prop": "txt", "title": "$Comment", "type": "textarea" }]
    }
    ```

    Более подробно формы описаны в forms.md

  - **dbs** - папка содержит информацию о коллекциях, таблицах, списках, деревьях. Используется сервером для структурирования данных.

     - **collections.json** - имена коллекций и папки для хранения (для движка "nedb")

      Все коллекции из списка инициализируются при старте сервера 

     ```
     {
      "lists": { "folder": "jbasepath" },
       "devices": { "folder": "jbasepath" },
       "users": { "folder": "privatepath" },
       ..
     }
     ```

    - **tables.json** - описание таблиц системы. 
    
    Одна коллекция может состоять из одной или нескольких таблиц. Например, все папки (группы) хранятся в коллекции lists, поле list определяет конкретный список (таблицу)

      - collection -  имя коллекции
      - filter - фильтр (при создании новой записи поля, включенные в фильтр, заполняются )
      - defRootTitle - Название корневой папки, если записи о корневой папке не существует  
      - default -  Шаблон для создания новой записи
      - ruleID  - Правила формирования _id: { "pref": "tg", "len": 3 } => "tg001"

    ```
    {
      "typegroup": {   //  имя таблицы
        "store": "db", 
        "collection": "lists",   
       "filter": { "list": "typegroup" }, 
       "defRootTitle": "$Types",  
       "default": { "name": "$NewFolder" },
       "ruleID": { "pref": "tg", "len": 3 } 
     },
    .....
    }
    ```

  - **lists.json** - описание списков
  
   Списки формируются на основе таблиц, в описание включается имя таблицы и маппинг полей для получения списка

    ```
    {
      "typeList": {
        "table": "type",
        "propmap": { "_id": "id", "name": "title" }
      },...
    }
    ```
 
 - **trees.json** - описание деревьев
  
   Деревья формируются на основе таблиц.
   
   В описание включаются имена таблиц и маппинг полей.
  
   Дерево может состоять из нескольких поддеревьев (нескольких корней). Такие деревья описаны массивом идентификаторов простых деревьев

  ```
   {
     "dev": ["devices", "types"],
      "devices": {
        "branch": { "table": "place", "propmap": { "_id": "id", "name": "title", "parent": "parent", "order": "order" } },
        "leaf": { "table": "device", "propmap": { "_id": "id", "name": "title", "parent": "parent", "order": "order" } }
      },
     "types": {
       "branch": {
         "table": "typegroup",
         "propmap": { "_id": "id", "name": "title", "parent": "parent", "order": "order" }
        },
       "leaf": { "table": "type", "propmap": { "_id": "id", "name": "title", "parent": "parent", "order": "order" } }
     },...
   }

  ```
    

