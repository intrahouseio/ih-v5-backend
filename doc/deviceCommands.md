 ## **Свойства-команды**

Наследуются от типа

Имеют атрибуты:

  - **функция - команда** (виртуальная команда)

Функция переключает свойства устройства, реализуя команду

Пример: Дискретный актуатор

Это его виртуальная реализация:

```
|--------|---------|---------------------------------------
|Свойство|Операция |Функция
|--------|---------|---------------------------------------
|value   |RW       |
|on      |Command  | dev.set('value', 1)
|off     |Command  | dev.set('value', 0)
|toggle  |Command  | if (dev.value) dev.off() else dev.on()

```

Если привязать свойство value к каналу RW, то будет работать:

```
dev.on() =>  dev.set('value',1) => есть канал для записи

         write
value ----------------->> set value:1 ->> Плагин

         read
value <<-----------------      value:1 <<-Плагин
```

Причем, в большинстве плагинов можно обойтись такой реализацией, даже если адреса для чтения и записи разные (отдельный адрес - управление, отдельный - состояние)

Канал Modbus:
  - Read - 1
  - Адрес для чтения ....

   - Write - 1
   - Настроить адрес для записи (иначе исп адрес для чтения):...
   - Функция (выражение) при записи:  value==0 ? 77 : FF

Канал mqtt:
   
   - Read - 1
   - topic: /dev/status/lamp1

   - Write - 1
   - topic: /dev/command/lamp1
   - Функция (выражение) при записи:  value==0 ? Off : On


НО есть ситуации, где такой подход не работает:

mqtt:
 - отправить для on  /dev/on/lamp1
 - отправить для off /dev/off/lamp1

То есть разные топики для on / off команд

modbus (PLC c программой или два разных реле):
 - отправить для on  по адресу xx значение 1
 - отправить для off по адресу уу значение 1

В этом случае нужно создать каналы для каждой команды:

```
dev.on() =>  есть прямой канал для записи

         write
on  ----------------->> on ->> Плагин

         read
value <<-----------------  value:1 <<-Плагин
Состояние должно поступить как результат выполнения команды 
```

### Медленные каналы

В случае медленного канала (или даже без обратной связи) 
нужна возможность установить значение прямо при записи. 

Также это полезно при записи свойств-параметров 

```
dev.on() =>  dev.set('value',1) => есть канал для записи

         write
value ----------------->> set value:1 ->> Плагин
set value:1 - сразу при отправке

         read
value <<-----------------      value:1 <<-Плагин
 придет позже, но изменения нет, ничего не произойдет, а пользователь не будет волноваться

value <<-----------------      value:0 <<-Плагин
  или считается значение 0 - команда не выполнилась

```
Для реализации такой возможности добавить флаг:

**Установить значение сразу при записи (при отправке)**

Этот флаг д б доступен для свойств, привязанных к каналу с op-RW (W)

В том числе для команд:

```
dev.on() =>  есть прямой канал для записи

         write
on  ----------------->> on ->> Плагин
set value:1 - сразу при отправке выполнить виртуальную команду
```

НО ЕСЛИ  value тоже привязано к каналу RW, команду set на плагин отправлять не нужно!!

Пример: аналоговый актуатор



### Реализация импульсного управления

```
|--------|---------|---------------------|------------------
|Свойство|Операция |Функция              | Канал
|--------|---------|---------------------|-----------------
|value   |R        |                     | Канал для чтения 
|control |W        |                     | Канал для записи
|on      |Command  |  impOn              |
|off     |Command  |  imOff              |

function impOn() {
  if (dev.value) return; // уже включено
  dev.write('control', 1); //  ?? отличается от set тем что только передает команду в канал
  setTimeout(() => {dev.write('control', 0)}, 100); // импульс 100 мс, но точность не гарантируется
}

```
Но виртуально работать не будет!
Можно проверять внутри привязку к каналу?

### Реализация управления двумя реле (одно нужно включать, другое - выключать с задержкой?)

```
|--------|---------|---------------------|------------------
|Свойство|Операция |Функция              | Канал
|--------|---------|---------------------|-----------------
|value   |R        |                     | Канал для чтения 
|control1|W        |                     | Канал для записи
|control2|W        |                     | Канал для записи
|on      |Command  | R2On                |
|off     |Command  | R2Off               |

function R2On() {
  if (dev.value) return; // уже включено
  dev.write('control2', 0); // Отключить один потенциал и включить другой
  setTimeout(() => {dev.write('control1', 1)}, 100); 
}

```







